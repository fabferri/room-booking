# ==================================================================================
# Nginx Configuration for Room Booking System
# ==================================================================================
# This configuration sets up Nginx as a reverse proxy that:
#   1. Serves static frontend files (HTML, CSS, JavaScript)
#   2. Proxies API requests to the backend Node.js server
#   3. Handles routing for the single-page application (SPA)
# ==================================================================================

# ==================================================================================
# EVENTS BLOCK
# ==================================================================================
# Configures connection processing behavior

events {
    # Maximum number of simultaneous connections per worker process
    # 1024 is a reasonable default for moderate traffic
    # Increase for high-traffic scenarios
    worker_connections 1024;
}

# ==================================================================================
# HTTP BLOCK
# ==================================================================================
# Main HTTP server configuration

http {
    # ==================================================================================
    # MIME TYPES AND DEFAULTS
    # ==================================================================================
    
    # Include standard MIME type mappings (e.g., .css -> text/css, .js -> application/javascript)
    # This ensures browsers interpret files correctly
    include /etc/nginx/mime.types;
    
    # Default MIME type for files without a recognized extension
    # application/octet-stream tells browsers to download rather than display
    default_type application/octet-stream;

    # ==================================================================================
    # PERFORMANCE SETTINGS
    # ==================================================================================
    
    # Enable sendfile for efficient file serving
    # Allows Nginx to send files directly from disk without copying to buffer
    sendfile on;
    
    # Keep connections alive for 65 seconds to reduce overhead of creating new connections
    # Clients can reuse the same connection for multiple requests
    keepalive_timeout 65;

    # ==================================================================================
    # SERVER BLOCK
    # ==================================================================================
    # Virtual server configuration for Room Booking System
    
    server {
        # Listen on port 80 (standard HTTP port)
        listen 80;
        
        # Server name - accepts requests for localhost
        # In production, replace with actual domain name
        server_name localhost;

        # ==============================================================================
        # FRONTEND LOCATION - Serve Static Files
        # ==============================================================================
        # Serves the single-page application (SPA) frontend
        # Handles all non-API routes
        
        location / {
            # Root directory containing static files (HTML, CSS, JS)
            root /usr/share/nginx/html;
            
            # Default file to serve when directory is requested
            index index.html;
            
            # SPA routing configuration:
            # 1. Try to serve the exact file requested ($uri)
            # 2. Try to serve as a directory ($uri/)
            # 3. Fall back to index.html (allows client-side routing to work)
            # This is crucial for SPAs where routing is handled by JavaScript
            try_files $uri $uri/ /index.html;
        }

        # ==============================================================================
        # BACKEND API LOCATION - Reverse Proxy to Node.js
        # ==============================================================================
        # Proxies all /api/* requests to the backend Node.js server
        # Backend runs on port 3000 inside the 'backend' Docker container
        
        location /api/ {
            # Forward requests to backend server
            # 'backend' is the Docker service name (Docker DNS resolves this)
            # Port 3000 is where the Express server listens
            proxy_pass http://backend:3000/api/;
            
            # Use HTTP/1.1 for proxy connection (required for WebSockets and keep-alive)
            proxy_http_version 1.1;
            
            # WebSocket support headers
            # Allows upgrade from HTTP to WebSocket if needed
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            
            # Preserve original host header
            # Backend sees the original hostname requested by client
            proxy_set_header Host $host;
            
            # Pass client's real IP address to backend
            # Useful for logging and rate limiting
            proxy_set_header X-Real-IP $remote_addr;
            
            # Pass complete forwarding chain
            # Shows all proxies the request passed through
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # Pass original protocol (http/https)
            # Backend can detect if original request was secure
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Bypass cache for upgraded connections
            # Ensures WebSocket upgrades aren't cached
            proxy_cache_bypass $http_upgrade;
        }
    }
}
